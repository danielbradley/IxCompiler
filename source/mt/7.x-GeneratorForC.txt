
.. Generator for C

~!include/ixcompiler.GeneratorForC.h~
#ifndef IXCOMPILER_GENERATORFORC_H
#define IXCOMPILER_GENERATORFORC_H

#include "ixcompiler.h"

int Generator_FunctionForC( const IxSourceUnitCollection* source_units, const Path* output_path );

#endif
~

~!c/ixcompiler.GeneratorForC.c~
#include <stdio.h>
#include "ixcompiler.ArrayOfIxSourceMember.h"
#include "ixcompiler.ArrayOfIxSourceMethod.h"
#include "ixcompiler.ArrayOfString.h"
#include "ixcompiler.Console.h"
#include "ixcompiler.Dictionary.h"
#include "ixcompiler.File.h"
#include "ixcompiler.GeneratorForC.h"
#include "ixcompiler.IxSourceClass.h"
#include "ixcompiler.IxSourceMember.h"
#include "ixcompiler.IxSourceMethod.h"
#include "ixcompiler.IxSourceUnit.h"
#include "ixcompiler.IxSourceUnitCollection.h"
#include "ixcompiler.Path.h"
#include "ixcompiler.Platform.h"
#include "ixcompiler.String.h"
#include "ixcompiler.StringBuffer.h"

#define TARGET_HEADER_NAME "/include/"
#define TARGET_SOURCE_NAME "/c/"

static void    GenerateAndWriteHeaderFile( const IxSourceUnitCollection* sourceUnits, const String* outputDir );
static String* GenerateHeaderFile        ( const IxSourceUnitCollection* sourceUnits );
static String* GenerateIfDef             ( const IxSourceUnit*           sourceUnit  );
static String* GenerateTypeDef           ( const String*                 type,        int           longest  );

static void    GenerateAndWriteSourceFile        ( const IxSourceUnitCollection* sourceUnits, const String* outputDir );
static String* GenerateSourceFile                ( const IxSourceUnitCollection* sourceUnits );
static String* GenerateIncludes                  ( const IxSourceUnitCollection* sourceUnits );
static String* GenerateStructs                   ( const IxSourceUnitCollection* sourceUnits );
static String* GenerateStructForSourceUnit       ( const IxSourceUnit*           sourceUnit, const Dictionary* resolvedTypes );
static String* GenerateStructMembersForSourceUnit( const IxSourceUnit*           sourceUnit, const Dictionary* resolvedTypes );
static String* GenerateMethods                   ( const IxSourceUnitCollection* sourceUnits );
static String* GenerateMethodsForSourceUnit      ( const IxSourceUnit*           sourceUnit  );
~

~c/ixcompiler.GeneratorForC.c~
int Generator_FunctionForC( const IxSourceUnitCollection* sourceUnits, const Path* outputPath )
{
    int         n                 = IxSourceUnitCollection_getLength( sourceUnits );
    String*     output_dir        = String_new( Path_getFullPath( outputPath ) );
    String*     target_header     = String_new( TARGET_HEADER_NAME );
    String*     target_source     = String_new( TARGET_SOURCE_NAME );
    String*     target_header_dir = String_cat( output_dir, target_header );
    String*     target_source_dir = String_cat( output_dir, target_source );
    Path*       target_header_path = Path_new( String_content( target_header_dir ) );
    Path*       target_source_path = Path_new( String_content( target_source_dir ) );

    if ( !Platform_Path_Create( target_header_path ) )
    {
        Console_Write( "Aborting. Could not create output header dir: %s\n", String_content( target_header_dir ) );
        Platform_Exit( -1 );
    }

    if ( !Platform_Path_Create( target_source_path ) )
    {
        Console_Write( "Aborting. Could not create output source dir: %s\n", String_content( target_source_dir ) );
        Platform_Exit( -1 );
    }

    Console_Write( "Output header dir: %s\n", String_content( target_header_dir ) );
    Console_Write( "Output source dir: %s\n", String_content( target_source_dir ) );

    GenerateAndWriteHeaderFile( sourceUnits, target_header_dir );
    GenerateAndWriteSourceFile( sourceUnits, target_source_dir );

    for ( int i=0; i < n; i++ )
    {
    }

    String_free( &output_dir        );
    String_free( &target_header     );
    String_free( &target_source     );
    String_free( &target_header_dir );
    String_free( &target_source_dir );

    return SUCCESS;
}
~

