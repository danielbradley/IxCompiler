
.. IxSourceUnit

~!include/ixcompiler.IxSourceUnit.h~
#ifndef IXCOMPILER_IXSOURCEUNIT_H
#define IXCOMPILER_IXSOURCEUNIT_H

#include "ixcompiler.h"

IxSourceUnit* IxSourceUnit_new( const AST* ast );

IxSourceUnit*                IxSourceUnit_free             (       IxSourceUnit** self );
const String*                IxSourceUnit_getName          ( const IxSourceUnit*  self );
const String*                IxSourceUnit_getPackage       ( const IxSourceUnit*  self );
const String*                IxSourceUnit_getFullName      ( const IxSourceUnit*  self );
const char*                  IxSourceUnit_getPrefix        ( const IxSourceUnit*  self );

const IxSourceClass*         IxSourceUnit_getClass         ( const IxSourceUnit*  self );
const ArrayOfString*         IxSourceUnit_getSignatures    ( const IxSourceUnit*  self );
const ArrayOfString*         IxSourceUnit_getCopyrightLines( const IxSourceUnit*  self );
const ArrayOfString*         IxSourceUnit_getLicenseLines  ( const IxSourceUnit*  self );
const Array*                 IxSourceUnit_getMethods       ( const IxSourceUnit*  self );

#endif
~

~!c/ixcompiler.IxSourceUnit.c~
#include "ixcompiler.Array.h"
#include "ixcompiler.ArrayOfString.h"
#include "ixcompiler.AST.h"
#include "ixcompiler.Console.h"
#include "ixcompiler.EnumTokenGroup.h"
#include "ixcompiler.EnumTokenType.h"
#include "ixcompiler.File.h"
#include "ixcompiler.IxSourceClass.h"
#include "ixcompiler.IxSourceInterface.h"
#include "ixcompiler.IxSourceMethod.h"
#include "ixcompiler.IxSourceUnit.h"
#include "ixcompiler.Node.h"
#include "ixcompiler.NodeIterator.h"
#include "ixcompiler.Platform.h"
#include "ixcompiler.String.h"
#include "ixcompiler.StringBuffer.h"
#include "ixcompiler.Tree.h"
#include "ixcompiler.Token.h"
#include "ixcompiler.TokenGroup.h"

struct _IxSourceUnit
{
    bool                       invalid;
    String*                    package;
    String*                    filename;
    String*                    name;
    String*                    extension;
    String*                    prefix;
    String*                    fullName;
    ArrayOfString*             copyrightLines;
    ArrayOfString*             licenseLines;
    IxSourceClass*             class;
    IxSourceInterface*         interface;
    Array*                     methods;
    Array*                     functions;
};

static void    init        ( IxSourceUnit* self, const AST* ast );
static void    initChildren( IxSourceUnit* self, const AST* ast );
static void    initPrefix  ( IxSourceUnit* self                 );
static void    initFullName( IxSourceUnit* self                 );
static String* CreateLine  ( const char* prefix, const Node* node );

~

~c/ixcompiler.IxSourceUnit.c~
IxSourceUnit* IxSourceUnit_new( const AST* ast )
{
    IxSourceUnit* self = Platform_Alloc( sizeof( IxSourceUnit ) );
    if ( self )
    {
        init        ( self, ast );
        initChildren( self, ast );
        initPrefix  ( self      );
        initFullName( self      );
    }
    return self;
}
~

~c/ixcompiler.IxSourceUnit.c~
IxSourceUnit* IxSourceUnit_free( IxSourceUnit** self )
{
    if ( *self )
    {
        String_free           ( &(*self)->package        );
        String_free           ( &(*self)->filename       );
        String_free           ( &(*self)->name           );
        String_free           ( &(*self)->extension      );
        String_free           ( &(*self)->prefix         );
        String_free           ( &(*self)->fullName       );
        ArrayOfString_free    ( &(*self)->copyrightLines );
        ArrayOfString_free    ( &(*self)->licenseLines   );
        IxSourceClass_free    ( &(*self)->class          );
        IxSourceInterface_free( &(*self)->interface      );
        Array_free            ( &(*self)->methods        );
        Array_free            ( &(*self)->functions      );

        Platform_Free( self );
    }
    return *self;
}
~

~c/ixcompiler.IxSourceUnit.c~
const String* IxSourceUnit_getName( const IxSourceUnit* self )
{
    return self->name;
}
~

~c/ixcompiler.IxSourceUnit.c~
const String* IxSourceUnit_getPackage( const IxSourceUnit* self )
{
    return self->package;
}
~

~c/ixcompiler.IxSourceUnit.c~
const char* IxSourceUnit_getPrefix( const IxSourceUnit* self )
{
    return String_content( self->prefix );
}
~

~c/ixcompiler.IxSourceUnit.c~
const String* IxSourceUnit_getFullName( const IxSourceUnit* self )
{
    return self->fullName;
}
~

~c/ixcompiler.IxSourceUnit.c~
const IxSourceClass* IxSourceUnit_getClass( const IxSourceUnit* self )
{
    return self->class;
}
~

~c/ixcompiler.IxSourceUnit.c~
const ArrayOfString* IxSourceUnit_getCopyrightLines( const IxSourceUnit* self )
{
    return self->copyrightLines;
}
~

~c/ixcompiler.IxSourceUnit.c~
const ArrayOfString* IxSourceUnit_getLicenseLines( const IxSourceUnit* self )
{
    return self->licenseLines;
}
~

~c/ixcompiler.IxSourceUnit.c~
const Array* IxSourceUnit_getMethods( const IxSourceUnit* self )
{
    return self->methods;
}
~

~c/ixcompiler.IxSourceUnit.c~
static void init( IxSourceUnit* self, const AST* ast )
{
    String*        source_file_path = String_new( File_getFilePath( AST_getTokenizerFile( ast ) ) );
    ArrayOfString* parts            = String_split( source_file_path, '/' );
    int            len              = ArrayOfString_getLength( parts );

    self->package  = String_copy( ArrayOfString_getObject( parts, len - 2 ) );
    self->filename = String_copy( ArrayOfString_getObject( parts, len - 1 ) );

    ArrayOfString* bits = String_split( self->filename, '.' );
    self->name          = String_copy( ArrayOfString_getObject( bits, 0 ) );
    self->extension     = String_copy( ArrayOfString_getObject( bits, 1 ) );

    String_free       ( &source_file_path );
    ArrayOfString_free( &parts            );
    ArrayOfString_free( &bits             );
}
~

~c/ixcompiler.IxSourceUnit.c~
static void initChildren( IxSourceUnit* self, const AST* ast )
{
    self->copyrightLines = ArrayOfString_new();
    self->licenseLines   = ArrayOfString_new();
    self->methods        = Array_new( (Destructor) IxSourceMethod_free );

    const Tree* tree = AST_getTree ( ast  );
    const Node* root = Tree_getRoot( tree );    

    String* copyright = String_new( "copyright" );
    String* license   = String_new( "license"   );
    String* class     = String_new( "class"     );
    String* method    = String_new( "method"    );

    NodeIterator* it = Node_iterator( root );
    while ( NodeIterator_hasNonWhitespace( it ) )
    {
        const Node*   node  = NodeIterator_next( it );
        const String* tag   = Node_getTag( node );
        const Token*  token = Node_getToken( node );
        EnumTokenType type  = Token_getTokenType( token );

        if ( tag && String_equals( tag, copyright ) )
        {
            String* t = CreateLine( "", node );
            ArrayOfString_push( self->copyrightLines, &t );
        }
        else
        if ( tag && String_equals( tag, license ) )
        {
            ArrayOfString_push( self->licenseLines, (String**) Give( CreateLine( "", node ) ) );
        }
        else
        if ( tag && String_equals( tag, class ) )
        {
            if ( ! self->class )
            {
                self->class = IxSourceClass_new( node );
            }
            else
            {
                self->invalid = TRUE;
            }
        }
        else
        if ( tag && String_equals( tag, method ) )
        {
            Array_push( self->methods,  Give( IxSourceMethod_new( self, node ) ) );
        }
    }

    String_free( &copyright );
    String_free( &license   );
    String_free( &class     );
}
~

~c/ixcompiler.IxSourceUnit.c~
static void initPrefix( IxSourceUnit* self )
{
    StringBuffer* sb  = StringBuffer_new();
    String*       pkg = String_replace( self->package, '.', '_' );
    {
        StringBuffer_append( sb, String_content( pkg ) );
        StringBuffer_append( sb, "_"                             );
        StringBuffer_append( sb, String_content( self->name    ) );

        self->prefix = String_new( StringBuffer_content( sb ) );
    }
    String_free      ( &pkg );
    StringBuffer_free( &sb  );
}
~

~c/ixcompiler.IxSourceUnit.c~
static void initFullName( IxSourceUnit* self )
{
    StringBuffer* sb  = StringBuffer_new();
    {
        StringBuffer_append( sb, String_content( self->package ) );
        StringBuffer_append( sb, "."                             );
        StringBuffer_append( sb, String_content( self->name    ) );

        self->fullName = String_new( StringBuffer_content( sb ) );
    }
    StringBuffer_free( &sb  );
}
~

~c/ixcompiler.IxSourceUnit.c~
String* CreateLine( const char* prefix, const Node* node )
{
    String* line = null;
    {
        StringBuffer* sb     = StringBuffer_new();
        String*       export = Node_export( node );
        {
            StringBuffer_append( sb, prefix );
            StringBuffer_append( sb, String_content( export ) );

            line = String_new( StringBuffer_content( sb ) );
        }
        StringBuffer_free( &sb     );
        String_free      ( &export );
    }
    return line;
}
~
